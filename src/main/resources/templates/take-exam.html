<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <title th:text="${exam.title}">Take Exam</title>
    <style>
        body { font-family: Arial, sans-serif; background: #f4f4f4; margin:0; padding:0;}
        .container { max-width:900px; margin: 30px auto; background:white;
            padding: 25px; border-radius:8px; box-shadow:0 0 8px rgba(0,0,0,0.1);}
        h1 { color:#007bff; display:flex; justify-content:space-between; align-items:center; margin-top:0;}
        .exam-meta { margin-bottom:20px; }

        /* Question Nav Boxes */
        .question-nav { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 15px; }
        .q-box {
            width: 35px; height: 35px; border-radius: 4px; background: #ddd;
            display: flex; align-items: center; justify-content: center;
            font-weight: bold; cursor: pointer; user-select: none;
        }
        .q-box:hover { background: #ccc; }
        .q-box.active { background: #007bff; color: white; }
        .q-box.answered { background: #28a745; color: white; }

        .question-container { display: none; }
        .question-container.active { display: block; }
        .question { background:#f9f9f9; border:1px solid #ddd; padding:15px; border-radius:6px; margin-bottom:20px;}
        .question p { font-weight:bold; margin-bottom:8px;}
        .option { display:block; margin-bottom:5px; cursor: pointer; }
        .option input { margin-right:8px; }

        .nav-buttons { display: flex; justify-content: space-between; margin-top: 10px; }
        button { padding: 10px 18px; border: none; border-radius: 4px; font-weight: bold; cursor: pointer; }
        .btn-prev { background: #6c757d; color: white; }
        .btn-prev:hover { background: #5a6268; }
        .btn-next { background:#007bff; color:white; }
        .btn-next:hover { background:#0056b3; }
        .btn-submit { background:#28a745; color:white; }
        .btn-submit:hover { background:#1e7e34; }

        .timer {
            background: #ffeb3b;
            padding: 6px 12px;
            border-radius: 4px;
            color: #000;
            font-weight: bold;
            font-size: 1rem;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>
        <span th:text="${exam.title}">Exam Title</span>
        <span class="timer" id="timer"></span>
    </h1>

    <div class="exam-meta">
        <p th:text="${exam.description}">Exam description...</p>
        <p><b>Duration:</b> <span th:text="${exam.durationMinutes}"></span> minutes</p>
        <p><b>Total Questions:</b> <span th:text="${#lists.size(exam.questions)}"></span></p>
    </div>

    <!-- Question Navigation Boxes -->
    <div class="question-nav" id="questionNav">
        <div th:each="q, qStat : ${exam.questions}"
             class="q-box"
             th:attr="data-index=${qStat.index}"
             th:text="${qStat.index + 1}">1</div>
    </div>

    <form id="examForm" th:action="@{/user/submit-exam/{id}(id=${exam.id})}" method="post">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />

        <!-- Questions -->
        <div th:each="q, qStat : ${exam.questions}"
             class="question-container"
             th:attr="data-index=${qStat.index}">
            <div class="question">
                <p th:text="'Q' + (${qStat.index} + 1) + '. ' + ${q.text}">Question text</p>
                <label class="option" th:each="op : ${q.options}">
                    <input type="radio" th:name="'q_' + ${q.id}" th:value="${op.id}"
                           th:onchange="markAnswered([[${qStat.index}]])">
                    <span th:text="${op.text}">Option text</span>
                </label>
            </div>
        </div>

        <!-- Navigation -->
        <div class="nav-buttons">
            <button type="button" id="prevBtn" class="btn-prev">⬅ Previous</button>
            <button type="button" id="nextBtn" class="btn-next">Next ➡</button>
            <button type="submit" id="submitBtn" class="btn-submit" style="display:none;">Submit Exam</button>
        </div>
    </form>
</div>

<script>
    let currentIndex = 0;
    const questions = document.querySelectorAll('.question-container');
    const qBoxes = document.querySelectorAll('.q-box');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const submitBtn = document.getElementById('submitBtn');

    function showQuestion(index) {
        questions.forEach((q, i) => q.classList.toggle('active', i === index));
        qBoxes.forEach((box, i) => box.classList.toggle('active', i === index));
        prevBtn.style.display = index === 0 ? 'none' : 'inline-block';
        nextBtn.style.display = index === questions.length - 1 ? 'none' : 'inline-block';
        submitBtn.style.display = index === questions.length - 1 ? 'inline-block' : 'none';
        currentIndex = index;
    }

    // Handle Next/Prev clicks
    prevBtn.addEventListener('click', () => currentIndex > 0 && showQuestion(currentIndex - 1));
    nextBtn.addEventListener('click', () => currentIndex < questions.length - 1 && showQuestion(currentIndex + 1));

    // Handle click on question number boxes
    qBoxes.forEach((box, idx) => {
        box.addEventListener('click', () => showQuestion(idx));
    });

    // Mark question as answered
    function markAnswered(index) {
        qBoxes[index].classList.add('answered');
    }

    showQuestion(currentIndex);

    /* ===== Timer Logic ===== */
    const timerDisplay = document.getElementById('timer');
    let timeLeft = /*[[${exam.durationMinutes}]]*/ 10 * 60; // total seconds

    function updateTimer() {
        const mins = Math.floor(timeLeft / 60);
        const secs = timeLeft % 60;
        timerDisplay.textContent = `${String(mins).padStart(2, '0')}:${String(secs).padStart(2, '0')}`;
        if (timeLeft <= 0) {
            clearInterval(timerInterval);
            alert("Time's up! Submitting your exam.");
            document.getElementById('examForm').submit();
            setTimeout(() => {
                window.location.href = "/user/dashboard";
            }, 5000); // Render-safe redirect delay
        }
        timeLeft--;
    }
    updateTimer();
    const timerInterval = setInterval(updateTimer, 1000);
</script>

</body>
</html>
